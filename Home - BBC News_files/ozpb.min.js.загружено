"use strict";console.log("Ozone INCLUDE JS PAGE: 20230426 09:00"),console.log("*** This version MUST FIND a CMP and polls until we discover the CMP, MAX of 600ms tho ***");var configVars={ozonePrebidFile_src:"https://prebid.the-ozone-project.com/hw/bbc/prebid-bbc-ozone.min.js",includeMenu:!1,deleteUspapi:!1},PREBID_TIMEOUT=2e3,testgroup=Math.floor(99*Math.random()),pbjs=pbjs||{},startTime=(pbjs.que=pbjs.que||[],Date.now()),isPbjs=document.location.search.match("pbjs_debug=true");function ozoneLog(){if(isPbjs){let e=1<arguments.length?arguments:arguments[0];console.log(`%cOZONE wrapper : ${Date.now()-startTime}ms`,"background-color: #AFA; border-radius:5px",e)}}function ozoneError(){if(isPbjs){let e=1<arguments.length?arguments:arguments[0];console.error(`%cOZONE wrapper:  ${Date.now()-startTime}ms`,"background-color: #FAA; border-radius:5px",e)}}var ozoneadunits=ozoneadunits||{};ozoneadunits.cmd=ozoneadunits.cmd||[];try{ozoneLog("googletag cmd 1 is ",JSON.parse(JSON.stringify(window.googletag.cmd)))}catch(e){ozoneLog("googletag cmd does not exist (1)")}try{let e=window.googletag.pubads().getSlots();0<e.length&&ozoneError(`ozone was loaded too late to intercept enableServices; googletag.pubads().getSlots() contains ${e.length} item(s)`)}catch(e){ozoneLog("ozone pbjs.js was loaded early enough to intercept enableServices :-)"),window.googletag=window.googletag||{},window.googletag.cmd=window.googletag.cmd||[];try{ozoneLog("googletag cmd 2 is ",JSON.parse(JSON.stringify(window.googletag.cmd)))}catch(e){ozoneError("googletag cmd does not exist (2)")}googletag.cmd.push(function(){var o,t=window.googletag;t.enableServices?(ozoneLog("disabling initialLoad"),window.googletag.pubads().disableInitialLoad(),o=t.enableServices,t.enableServices=function(){ozoneLog("googletag.enableServices has been called!");var e=o.apply(t,arguments);return ozoneLog("going to call ozoneFetchBids"),ozoneWrapper.ozoneFetchBids(),ozoneLog("going to return from googletag.enableServices"),e},ozoneLog("ozone captured googletag.enableServices")):ozoneError("could not bind to gpt googletag api")});try{ozoneLog("googletag cmd 3 is ",JSON.parse(JSON.stringify(window.googletag.cmd)))}catch(e){ozoneError("googletag cmd does not exist (3)")}}var menuFile,adunitsFile=document.createElement("script"),ozonePrebidFile=(adunitsFile.src="https://prebid.the-ozone-project.com/hw2/OZONEBBC4784/8890582654/current/adUnits.min.js",document.head.appendChild(adunitsFile),ozoneLog("pbjs.js: after writing script tag to include adunits.js"),document.createElement("script")),customPriceGranularityChoices=(ozonePrebidFile.src=configVars.ozonePrebidFile_src,document.head.appendChild(ozonePrebidFile),{low:"low",medium:"medium",high:"high",auto:"auto",dense:"dense",custom:{buckets:[]}}),ozoneWrapper=(pbjs.que.push(function(){let t={realTimeData:{dataProviders:[{name:"permutive",waitForIt:!0,params:{acBidders:["ozone"],maxSegs:500}}],auctionDelay:50},userSync:{userIds:[{name:"sharedId",storage:{type:"html5",name:"_sharedID",expires:365}}],filterSettings:{iframe:{bidders:"*",filter:"include",iframeEnabled:!0}},syncDelay:3e3},ozone:{singleRequest:!0,enhancedAdserverTargeting:!1},enableSendAllBids:!0,useBidCache:!1,priceGranularity:customPriceGranularityChoices.auto};ozoneWrapper.tcfapiLocator.timeStarted=Date.now(),function e(){if(ozoneLog("setCmpConfig called"),configVars.deleteUspapi&&(ozoneError("WARNING - deleting window.__uspapi for testing"),delete window.__uspapi),ozoneWrapper.tcfapiLocator.timerHasExpired()&&(ozoneLog("TCF locator has run out of time; setting gdpr & usp to false now."),ozoneWrapper.cmpGdpr=!1,ozoneWrapper.cmpUsp=!1),window.hasOwnProperty("__tcfapi")||ozoneWrapper.tcfapiLocator.timerHasExpired())if(ozoneWrapper.tcfapiLocator.timerHasExpired()?ozoneLog("CMP locator timer has expired - continuing with fake final consentManagement"):ozoneLog("FOUND CMP - now trying to add pbjsConfig.consentManagement"),null===ozoneWrapper.cmpGdpr)setTimeout(function(){ozoneLog(`Not found a value for GDPR yet - Going to call setCmpConfig again (elapsed=${ozoneWrapper.tcfapiLocator.searchMsElapsed()}ms, gdpr=${ozoneWrapper.cmpGdpr}, usp=${ozoneWrapper.cmpUsp})...`),ozoneWrapper.setCmpGdpr(),e()},ozoneWrapper.tcfapiLocator.waitMsBeforeRetrying);else if(null===ozoneWrapper.cmpUsp)ozoneWrapper.setCmpUsp(function(){ozoneWrapper.tcfapiLocator.timerHasExpired()?ozoneLog("CMP is still not fully loaded yet & we are out of retries"):ozoneLog(`Going to call setCmpConfig again (elapsed=${ozoneWrapper.tcfapiLocator.searchMsElapsed()}ms, gdpr=${ozoneWrapper.cmpGdpr}, usp=${ozoneWrapper.cmpUsp})...`),e()});else{ozoneLog(`CMP is fully loaded and we have values for gdpr (${ozoneWrapper.cmpGdpr}) and usp (${ozoneWrapper.cmpUsp})`);let e={},o=(ozoneWrapper.cmpGdpr&&(e.gdpr={cmpApi:"iab",allowAuctionWithoutConsent:!0,timeout:1e4,defaultGdprScope:!0,rules:[{purpose:"storage",enforcePurpose:!0,enforceVendor:!0,vendorExceptions:["permutive"]},{purpose:"basicAds",enforcePurpose:!0,enforceVendor:!0,vendorExceptions:[]}]}),ozoneWrapper.cmpUsp&&(e.usp={cmpApi:"iab",timeout:1e4}),0<Object.keys(e).length?(ozoneLog("adding consentManagement data protection object to prebid config: "+JSON.stringify(e)),t.consentManagement=e):ozoneLog("Will not add consentManagement object to pbjs config - no data protection applied here"),pbjs.setConfig(t),[]);ozoneLog(`setCmpConfig Executing ${(o=Array.isArray(ozoneWrapper.cmd)?ozoneWrapper.cmd:o).length} stored up commands from ozoneWrapper.cmd.`);for(let e=0;e<o.length;e++)ozoneLog("setCmpConfig Executing pushed command no."+e),o[e]();ozoneWrapper.cmd={push:function(e){e()}}}else ozoneWrapper.tcfapiLocator.timerHasExpired()?ozoneLog("__tcfapi is not available yet & we are out of time"):(ozoneLog(`__tcfapi is not available yet - we need to wait. ${ozoneWrapper.tcfapiLocator.searchMsElapsed()}ms elapsed so far...`),setTimeout(function(){e()},ozoneWrapper.tcfapiLocator.waitMsBeforeRetrying))}()}),{tcfapiLocator:{init:function(){ozoneWrapper.tcfapiLocator.timeoutMs=ozoneWrapper.tcfapiLocator.getTimeoutMs()},getTimeoutMs:function(){let e=document.location.search.match(/tcflocatems=\d+/);var o;return e?(ozoneLog("Setting the value of tcfapiLocator.timeoutMs to QS value of "+(o=parseInt(e[0].split("=")[1]))),o):5e3},timeoutMs:5e3,timeStarted:null,waitMsBeforeRetrying:20,searchMsElapsed:function(){return null===ozoneWrapper.tcfapiLocator.timeStarted?0:Date.now()-ozoneWrapper.tcfapiLocator.timeStarted},timerHasExpired:function(){return null!==ozoneWrapper.tcfapiLocator.timeStarted&&Date.now()-ozoneWrapper.tcfapiLocator.timeStarted>ozoneWrapper.tcfapiLocator.timeoutMs}},adserverRequestSent:!1,cmpGdpr:null,cmpUsp:null,cmd:[],startPrebidTimeout:function(e){ozoneLog("startPrebidTimeout called with ms value: "+e),ozoneWrapper.adserverRequestSent?ozoneLog("startPrebidTimeout - ads have already been requested, will not call for ads."):ozoneadunits.cmd.push(function(){ozoneLog(`(inside ozoneadunits.cmd fn) Setting a timeout to call sendAdserverRequest after ${e}ms`),setTimeout(function(){ozoneWrapper.adserverRequestSent?ozoneLog("prebid auction timeout handler - ads have already been requested, will not call for ads."):(ozoneLog(`prebid auction call timed out after ${e}ms - going to call sendAdServerRequest`),ozoneWrapper.sendAdserverRequest())},e)})},ozoneFetchBids:function(e){if(ozoneLog("ozoneFetchBids: document.readyState = "+document.readyState),"loading"===document.readyState)return!1;ozoneWrapper.adserverRequestSent=!1;let o=[];0<arguments.length?Array.isArray(e)?(ozoneLog("ozoneFetchBids received array as first arg (will use this as the set of div IDs to work on): ",arguments),o=e):ozoneLog("ozoneFetchBids received args, but first element was NOT an array (eh? why) we will ignore it: ",arguments):ozoneLog("ozoneFetchBids will work on all adunits known to googletag"),ozoneLog("pushing fn into ozoneWrapper.cmd to call processAdunitsWhichExist"),window.ozoneadunits.cmd.push(function(){ozoneLog("*** adUnits have loaded so will call processAdunitsWhichExist now ***",o),ozoneWrapper.processAdunitsWhichExist(o)})},targetingManager:{initialTargeting:{},getInitialTargetingForDivId:function(e){if(this.initialTargeting.hasOwnProperty(e))return this.initialTargeting[e];let o=ozoneWrapper.getGoogletagSlotsForDivIds([e])[0];return this.initialTargeting[e]=o.getTargetingMap(),this.initialTargeting[e]}},getUri:function(){return document.location.pathname.replace("/ozone/20220606-bbc-wrapper/bbc_test","")},processAdunitsWhichExist:function(t){let n=[];var r=googletag.pubads().getSlots();ozoneLog("processAdunitsWhichExist getSlots found full list of googletag slots: ",JSON.parse(JSON.stringify(r)));for(let o=0;o<r.length;o++){let e=r[o];var i,a=e.getSlotElementId();0<t.length&&-1===t.indexOf(a)?ozoneLog("processAdunitsWhichExist SKIPPING div ID : "+a):(ozoneLog("processAdunitsWhichExist OK div ID : "+a),ozoneLog("matchSection from uri is: "+(i=this.getMatchSectionFromUri(this.getUri()))),this.pushAdunitForUri(n,i,a,this.targetingManager.getInitialTargetingForDivId(a)))}if(n.length<1)return ozoneLog("processAdunitsWhichExist Found NO adunits to send to auction"),void(ozoneWrapper.adserverRequestSent?ozoneLog("Bidsbackhandler will not call sendAdserverRequest - its already been called"):(ozoneLog("Bidsbackhandler going to call sendAdserverRequest"),ozoneWrapper.sendAdserverRequest(t)));ozoneLog("processAdunitsWhichExist got list of adunits to send to auction",JSON.parse(JSON.stringify(n))),ozoneLog("going to push the auction calling function into ozoneWrapper.cmd"),ozoneWrapper.adserverRequestSent||ozoneWrapper.adserverRequestSent?ozoneLog("Ads have already been requested! We will not continue with the auction."):ozoneWrapper.cmd.push(function(){pbjs.que.push(function(){ozoneWrapper.adserverRequestSent?ozoneLog("Ads have already been requested! We will not call pbjs.requestBids"):(ozoneLog("going to call pbjs.requestBids"),pbjs.removeAdUnit(),pbjs.addAdUnits(n),ozoneWrapper.startPrebidTimeout(PREBID_TIMEOUT),pbjs.requestBids({bidsBackHandler:function(){ozoneWrapper.adserverRequestSent?ozoneLog("Bidsbackhandler will not call sendAdserverRequest - its already been called"):(ozoneLog("Bidsbackhandler going to call sendAdserverRequest"),ozoneWrapper.sendAdserverRequest(t))}}))})})},pushAdunitForUri:function(t,n,r,i){let a=0;for(let o=0;o<window.adUnits.length;o++){var e=window.adUnits[o].code.toString().split("|"),s=e[0],e=e[1];if(s===n&&e===r){let e=JSON.parse(JSON.stringify(window.adUnits[o]));ozoneLog(`MATCHED: ${n}|${r} ${window.adUnits[o].code.toString()} - updated adunit.code to: ${r} & added adunit to list for auction`),e.code=r,Object.assign(e.bids[0].params.customData[0].targeting,i),e.bids[0].params.customData[0].targeting.cont_type=ozoneWrapper.getSecOrArt(),e.bids[0].params.customData[0].targeting.section=n,e.bids[0].params.customData[0].targeting.gs_cat=googletag.pubads().getTargeting("gs_cat"),e.bids[0].params.customData[0].targeting.asset_type=googletag.pubads().getTargeting("asset_type"),e.bids[0].params.customData[0].targeting.testgroup=String(testgroup),t.push(e),ozoneLog("pushed adunit: ",e),a++}else ozoneLog(`Not matched: ${n}|${r} `+window.adUnits[o].code.toString())}return"ros"!==n&&0===a?(ozoneLog(`pushAdunitForUri: We did identify the section ${n} from the uri BUT we failed to find an adunit for ${n}|${r} SO we will see if we can find ros|${r} `),ozoneWrapper.pushAdunitForUri(t,"ros",r,i)):(0===a&&ozoneLog(`pushAdunitForUri: We did identify the section ${n} from the uri BUT we failed to find an adunit for ${n}|${r} AND we also failed to find ros|${r} `),a)},getSecOrArt:function(){let o=document.querySelectorAll('meta[property="og:type"]');for(let e=0;e<o.length;e++)if(ozoneLog("got og:type element: ",o[e]),"article"===o[e].getAttribute("content"))return"art";return"sec"},adunitNameRegexMatches:{sport:/^\/sport/,news_hub:/^\/news\/?$/,home:/^\/?$/,business:/^\/news\/business/,culture:/^\/culture/,entertainment:/^\/news\/entertainment(_and_arts|-arts)/,future:/^\/future/,sci_env:/^\/news\/science(_and_environment|-environment)/,technology:/^\/news\/technology/,travel:/^\/travel/,worklife:/^\/worklife/,weather:/^\/weather/,news_content:/^\/news\/.+$/},getMatchSectionFromUri:function(o){var t=Object.keys(this.adunitNameRegexMatches);for(let e=0;e<t.length;e++){var n=t[e],r=this.adunitNameRegexMatches[n];if(ozoneLog(`trying to match ${r} against ${o} - adunitNameFragment is `+n),o.match(r))return n}return"ros"},sendAdserverRequest:function(e){ozoneLog("In sendAdserverRequest : ozoneWrapper.adserverRequestSent = "+ozoneWrapper.adserverRequestSent),ozoneWrapper.adserverRequestSent=!0,ozoneLog("sendAdserverRequest going to refresh ads",e),googletag.cmd.push(function(){pbjs.que.push(function(){pbjs.setTargetingForGPTAsync(),ozoneWrapper.setCustomGptKeys(),Array.isArray(e)&&0<e.length?(ozoneLog("sendAdserverRequest going to refresh list of adunit IDs: ",e),googletag.pubads().refresh(ozoneWrapper.getGoogletagSlotsForDivIds(e))):(ozoneLog("sendAdserverRequest going to refresh ALL adunits"),googletag.pubads().refresh())})})},setCustomGptKeys:function(){var e;ozoneLog(`setCustomGptKeys going to set testgroup key (testgroup=${testgroup}) on adslots`);for(e of googletag.pubads().getSlots())e.setTargeting("testgroup",testgroup)},getGoogletagSlotsForDivIds:function(o){ozoneLog("Going to filter googletag slots by list: ",o);let e=googletag.pubads().getSlots();return e.filter(e=>-1<o.indexOf(e.getSlotElementId()))},setCmpGdpr:function(){if(ozoneLog("**** test before checking window.__tcfapi"),!window.hasOwnProperty("__tcfapi"))return ozoneLog("**** there is no window.__tcfapi function; assuming it will be here at some point so will wait for it..."),void ozoneLog("setCmpGdpr going to call the completion function");window.__tcfapi("ping",2,e=>{ozoneLog("**** test inside window.__tcfapi"),ozoneLog(`Found __tcfapi info after ${ozoneWrapper.tcfapiLocator.searchMsElapsed()}ms:`),ozoneLog(e),e.cmpLoaded?(ozoneLog("__tcfapi CMP is Loaded, success getting gdprApplies value "+e.gdprApplies),ozoneWrapper.cmpGdpr=e.gdprApplies):ozoneLog("__tcfapi cmpLoaded is false: pingReturn: "+JSON.stringify(e))}),ozoneLog("**** test after window.__tcfapi")},setCmpUsp:function(t){if(ozoneLog("**** test before checking window.__uspapi"),!window.hasOwnProperty("__uspapi"))return ozoneLog("**** there is no window.__uspapi function - returning/setting false for USP; will not retry - if it was going to be here it would be here by now"),ozoneWrapper.cmpUsp=!1,ozoneLog("setCmpUsp going to call the completion function"),void t();window.__uspapi("getUSPData",1,function(e,o){ozoneLog("**** test inside callback for window.__uspapi"),e.uspString?e.uspString.match("---")?(ozoneLog("USP is NOT active for this user; uspString is "+e.uspString),ozoneWrapper.cmpUsp=!1):(ozoneLog("USP is active for this user; uspString is "+e.uspString),ozoneWrapper.cmpUsp=!0):ozoneLog("USP data is not ready yet"),ozoneLog("setCmpUsp going to call the completion function"),t()}),ozoneLog("**** test after window.__uspapi")}});function ozoneFetchBids(){ozoneWrapper.ozoneFetchBids.apply(null,arguments)}ozoneWrapper.tcfapiLocator.init(),configVars.includeMenu?((menuFile=document.createElement("script")).src="https://www.ardm.io/ozone/20220606-bbc-wrapper/bbc_test/menu.js",document.head.appendChild(menuFile),ozoneLog("pbjs.js: included menu")):ozoneLog("skipping menu"),ozoneLog("setting long backstop timeout to call adserver if theres some very long problem with all the complex stuff thats going on with cmp->config rewriting->prebid"),ozoneWrapper.startPrebidTimeout(1e4),ozoneLog("bottom of Ozone pbjs.js");